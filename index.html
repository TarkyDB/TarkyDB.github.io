<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Tarkov Player Database</title>
    <script src="ag-grid-community.min.js"></script>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #grid-container {
            width: 100%;
            height: 100%;
        }

        .ag-header-cell-label>.ag-filter-icon,
        .ag-header-menu-always-show {
            display: none !important;
        }

        .ag-floating-filter {
            padding-left: 5px;
            padding-right: 10px;
        }

        .ag-ltr .ag-floating-filter-button {
            margin-left: 5px;
        }

        /*
        .ag-header-cell-label {
            justify-content: center;
        }
        */

        .ag-floating-bottom {
            overflow-y: hidden !important;
        }

        .blue {
            color: blue;
            cursor: pointer;
        }

        .ag-floating-bottom span {
            color: black !important;
        }

        .ag-horizontal-left-spacer {
            overflow-x: hidden;
        }

        .ag-horizontal-right-spacer {
            display: none;
        }

        .ag-floating-bottom {
            border-top: 2px solid black !important;
        }

        .ag-pinned-left-header,
        .ag-cell-last-left-pinned {
            border-right: 2px solid black !important;
        }


        /*
        .ag-theme-alpine {
            --ag-borders-critical: solid 2px;
        }*/
    </style>
</head>

<body>
    <div id="grid-container" class="ag-theme-alpine"></div>

    <script>
        console.time('GET');
        var db = [];
    </script>



    <script>
        console.timeEnd('GET');
    </script>


    <script>

        console.time('Total');
        buildTable();
        //var gridApi;

        var processedFile = 0;

        var gridApi;


        function cellRenderer(params) {
            return params.value;
        }

        function buildTable() {
            console.timeEnd('Total');
            let rowNumber = 1;

            var gridOptions = {
                //pagination: true,
                //paginationPageSize: 1000,
                suppressMenuHide: true,
                suppressDragLeaveHidesColumns: true,
                enableCellTextSelection: true,
                tooltipShowDelay: 0,
                valueCache: true,
                valueCacheNeverExpires: true,
                headerHeight: 30,
                pivotHeaderHeight: 30,
                columnDefs: [
                    //{ field: "#", headerName: '123', headerTooltip: "Number of row in the table" },
                    { field: "Name (Click to open profile)", headerTooltip: "Name of the player at 18 March of 2024", minWidth: 250, lockPinned: true, pinned: "left", cellClass: 'blue'/*, cellRenderer: nameRenderer*/ },
                    //{ field: "Account (Click to open profile)", headerTooltip: "Account number in Tarkov.dev", minWidth: 260, cellClass: 'blue', pinned: "left", lockPinned: true, },
                    { field: "Type", headerTooltip: "Account Type: Standard, EOD, Dev, Mod, Sherpa or Emissary" },
                    { field: "Banned", headerTooltip: "If the player is banned = YES", minWidth: 110 },
                    { field: "Level", headerTooltip: "Player level at 18 March of 2024", minWidth: 100, valueFormatter: cellRenderer },
                    { field: "Weapon", headerTooltip: "Most used weapon", minWidth: 125 },
                    { field: "Last Access", headerTooltip: "Last time a skill gained exp", minWidth: 135, filter: 'agDateColumnFilter', valueFormatter: formatDate },
                    { field: "Hours Played", headerTooltip: "Hours played since account creation", minWidth: 135, valueFormatter: cellRenderer },
                    { field: "Sessions", headerTooltip: "Raids played in this wipe", minWidth: 110, valueFormatter: cellRenderer },
                    { field: "Survived", headerTooltip: "Survived raids in this wipe", minWidth: 110, valueFormatter: cellRenderer },
                    { field: "Runthrough", headerTooltip: "Runthrough raids in this wipe", minWidth: 115, valueFormatter: cellRenderer },
                    { field: "Disconnect", headerTooltip: "Disconnect/Leave raids in this wipe", minWidth: 100, valueFormatter: cellRenderer },
                    { field: "K/D", headerTooltip: "Kills/Deaths Ratio", minWidth: 90, valueFormatter: cellRenderer },
                    { field: "Kills", headerTooltip: "Enemies killed by the player", minWidth: 100, valueFormatter: cellRenderer },
                    { field: "Killed", headerTooltip: "Number of times that the player has been killed in raid", minWidth: 105, valueFormatter: cellRenderer },
                    { field: "Deaths", headerTooltip: "Number of times that the player has died in raid (falls/hunger...)", minWidth: 105, valueFormatter: cellRenderer },
                    { field: "Attention", headerTooltip: "Skill Level", minWidth: 125, valueFormatter: cellRenderer },
                    { field: "Perception", headerTooltip: "Skill Level", minWidth: 125, valueFormatter: cellRenderer },
                    { field: "Strength", headerTooltip: "Skill Level", minWidth: 125, valueFormatter: cellRenderer },
                    { field: "Endurance", headerTooltip: "Skill Level", minWidth: 125, valueFormatter: cellRenderer },
                    { field: "Kill 7 Achievement", headerTooltip: "Eliminate 7 PMC operatives in a single raid while playing as a PMC", filter: 'agDateColumnFilter', valueFormatter: formatDate, minWidth: 200 },
                    { field: "Lightkeeper Achievement", headerTooltip: "Meet Lightkeeper for the first time while playing as a PMC", filter: 'agDateColumnFilter', valueFormatter: formatDate, minWidth: 200 },
                    { field: "Zryachiy Achievement", headerTooltip: "Eliminate Zryachiy for the first time while playing as a PMC", filter: 'agDateColumnFilter', valueFormatter: formatDate, minWidth: 200 },
                ],
                rowData: [],

                pinnedBottomRowData: [
                    {
                        "Name (Click to open profile)": "Filtered Players: 1.808.088 = 100%",
                        "Type": "Standard: 130.000",
                        "Banned": "0.64%",
                        "Level": "Avg: 20",
                        "Weapon": "Most: AK74",
                        "Hours Played": "Avg: 130",
                    },
                    {
                        "Name (Click to open profile)": "Accounts played this wipe: 20%",
                        "Type": "EOD: 500.000",
                        "Level": "Med: 20",
                        "Weapon": "Less: MDR",
                        "Hours Played": "Med: 13",
                    },
                    {
                        "Name (Click to open profile)": "Players captured: 75%",
                        "Type": "Sherpa/Emi: 300",
                        "Level": "Min: 10",
                        "Hours Played": "Min: 11",
                    },
                    {
                        "Name (Click to open profile)": "Data from March 2024",
                        "Type": "Dev, Mod: 140",
                        "Level": "Max: 70",
                        
                        "Hours Played": "Max: 70",
                    },
                ],
                defaultColDef: {
                    flex: 1,
                    minWidth: 150,
                    filter: true,
                    sortable: true,
                    floatingFilter: true
                },
                /*
                onFilterChanged: function () {
                    const columnDefs = gridApi.getColumnDefs();
                    columnDefs[0].headerName = `# (${gridApi.getDisplayedRowCount()})`; 
                    gridApi.setGridOption("columnDefs", columnDefs);
                }*/
            };

            const eGridDiv = document.querySelector('#grid-container');
            gridApi = agGrid.createGrid(eGridDiv, gridOptions);

            gridApi.showLoadingOverlay();

            var container = document.querySelector('.ag-body');
            container.addEventListener('click', function (event) {
                const clickedElement = event.target;
                const focusedCell = gridApi.getFocusedCell();
                if (!focusedCell) return;
                const row = gridApi.getDisplayedRowAtIndex(focusedCell.rowIndex);
                const cellValue = gridApi.getValue(focusedCell.column, row);
                //console.log(row);
                if (focusedCell.column.instanceId === 0) {
                    const id = extractNumbersInsideBrackets(cellValue);
                    window.open('https://tarkov.dev/player/' + id, '_blank');
                    //window.open(cellValue, '_blank');
                }
            });


        }

        function extractNumbersInsideBrackets(str) {
            // Regular expression to match numbers inside square brackets
            let regex = /\[(\d+)\]/g;

            // Array to store the extracted numbers
            let numbers = [];

            // Match the regular expression in the string
            let match;
            while ((match = regex.exec(str)) !== null) {
                // Add the matched number to the array
                numbers.push(parseInt(match[1]));
            }

            return numbers;
        }

        function formatDate(data) {
            const date = data.value;
            if (!date) return date;

            // Array of month names
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            const day = String(date.getDate()).padStart(2, '0'); // Get the day of the month (with leading zero if needed)
            const monthIndex = date.getMonth(); // Get the month index (0-based)
            const monthName = monthNames[monthIndex]; // Get the month name from the array
            const year = date.getFullYear(); // Get the full year

            // Format the date
            const formattedDate = `${day}/${monthName}/${year}`;
            return formattedDate;
        }

        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            // Months in JavaScript Date objects are 0-indexed, so we subtract 1 from the month
            return new Date(year, month - 1, day);
        }

        let fileNumber = 0;
        var loadingOverlay = document.querySelector('.ag-overlay-loading-center');


    </script>

    <script src="db-1.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-2.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-3.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-4.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-5.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-6.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-7.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-8.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-9.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-10.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-11.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-12.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-13.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-14.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-15.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-16.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-17.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-18.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-19.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-20.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-21.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-22.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-23.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-24.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-25.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-26.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-27.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-28.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-29.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-30.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-31.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data ${++fileNumber}/32`;</script>
    <script src="db-32.js"></script>
    <script>loadingOverlay.innerHTML = `Loading data completed`;</script>

    <script>

        function addLeadingZeros(number) {
            // Convert the number to a string
            let numberString = number.toString();

            // Calculate the number of zeros to add
            let zerosToAdd = 8 - numberString.length; // 7 is the length of 2 million in digits

            // Add the leading zeros
            for (let i = 0; i < zerosToAdd; i++) {
                numberString = '0' + numberString;
            }

            return numberString;
        }

        const rows = [];

        for (let part of db) {
            rows.push(...part);
        }

        rows.sort((a, b) => a[0] - b[0]);

        db = rows.map(function (row) {
            return {
                //"#": rowNumber++,
                //"Account (Click to open profile)": row[0],
                "Name (Click to open profile)": `[${addLeadingZeros(row[0])}] ` + row[1],
                "Type": row[2] ?? '',
                "Banned": row[3] ?? '',
                "Level": row[4] ?? '',
                "Weapon": row[5] ?? '',
                "Last Access": !isNaN(parseDate(row[6])) ? parseDate(row[6]) : null,
                "Hours Played": row[7] * 24 ?? '',
                "Sessions": row[8] ?? '',
                "Survived": row[9] ?? '',
                "Runthrough": row[10] ?? '',
                "Disconnect": row[11] ?? '',
                "K/D": row[12] ?? '',
                "Kills": row[13] ?? '',
                "Killed": row[14] ?? '',
                "Deaths": row[15] - row[14] ?? '',
                "Attention": row[16] ?? '',
                "Perception": row[17] ?? '',
                "Strength": row[18] ?? '',
                "Endurance": row[19] ?? '',
                "Kill 7 Achievement": !isNaN(parseDate(row[20])) ? parseDate(row[20]) : null,
                "Lightkeeper Achievement": !isNaN(parseDate(row[21])) ? parseDate(row[21]) : null,
                "Zryachiy Achievement": !isNaN(parseDate(row[22])) ? parseDate(row[22]) : null,
            };
        });
        //gridApi.setRowData(db);
        gridApi.setGridOption('rowData', db)
        gridApi.hideOverlay();
    </script>
</body>

</html>